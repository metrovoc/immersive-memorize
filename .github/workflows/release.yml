name: Release Extension

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Get version from manifest
      id: get_version
      run: |
        VERSION=$(node -p "require('./manifest.json').version")
        echo "version=v${VERSION}" >> $GITHUB_OUTPUT
        echo "Extension version: ${VERSION}"
        
    - name: Create extension package
      run: |
        # Create build directory
        mkdir -p build
        
        # Copy extension files
        cp manifest.json build/
        cp content_script.js build/
        cp -r icons build/
        cp -r popup build/
        cp -r options build/
        
        # Create zip package
        cd build
        zip -r "../immersive-memorize-${{ steps.get_version.outputs.version }}.zip" .
        cd ..
        
        # Create tar.gz package
        tar -czf "immersive-memorize-${{ steps.get_version.outputs.version }}.tar.gz" \
          manifest.json content_script.js icons/ popup/ options/
        
    - name: Verify package contents
      run: |
        echo "=== ZIP Package Contents ==="
        unzip -l "immersive-memorize-${{ steps.get_version.outputs.version }}.zip"
        echo ""
        echo "=== TAR.GZ Package Contents ==="
        tar -tzf "immersive-memorize-${{ steps.get_version.outputs.version }}.tar.gz"
        
    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸŽ¯ Immersive Memorize Chrome Extension
        
        ### Features
        - **é¡ºåºå­¦ä¹ æ¨¡å¼**: æ¯æ¬¡åªæ˜¾ç¤ºä¸€ä¸ªç”Ÿè¯ï¼Œä¸“æ³¨é«˜æ•ˆå­¦ä¹ 
        - **æ™ºèƒ½è¯æ±‡è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ« JLPT è¯æ±‡å¹¶é«˜äº®æ˜¾ç¤º
        - **å³æŒ‰å³å­¦**: æ— éœ€é¼ æ ‡æ‚¬åœï¼Œç›´æŽ¥æŒ‰å¿«æ·é”®å­¦ä¹ 
        - **è§†é¢‘æˆªå›¾**: è‡ªåŠ¨æ•èŽ·å½“å‰ç”»é¢ä½œä¸ºå­¦ä¹ å¡ç‰‡
        - **Anki å¯¼å‡º**: ä¸€é”®å¯¼å‡ºä¸º CSV æ ¼å¼ï¼Œç›´æŽ¥å¯¼å…¥ Anki
        - **è‡ªå®šä¹‰å¿«æ·é”®**: æ”¯æŒè‡ªå®šä¹‰å­¦ä¹ å¿«æ·é”®
        - **å·²å­¦è¯æ±‡è®°å¿†**: å·²å­¦è¯æ±‡ä¸å†æ˜¾ç¤ºï¼Œé¿å…é‡å¤å­¦ä¹ 
        
        ### Installation
        1. Download the `.zip` file below
        2. Extract it to a folder
        3. Open Chrome Extensions (`chrome://extensions/`)
        4. Enable "Developer mode"
        5. Click "Load unpacked" and select the extracted folder
        
        ### Usage
        1. Configure your JLPT vocabulary list in extension options
        2. Watch Japanese content on Netflix
        3. Press your hotkey (default: S) to learn highlighted words
        4. Export learned cards to Anki from the extension popup
        
        ### Files
        - `immersive-memorize-${{ steps.get_version.outputs.version }}.zip` - Chrome extension package (recommended)
        - `immersive-memorize-${{ steps.get_version.outputs.version }}.tar.gz` - Source archive
        EOF
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: Immersive Memorize ${{ steps.get_version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          immersive-memorize-${{ steps.get_version.outputs.version }}.zip
          immersive-memorize-${{ steps.get_version.outputs.version }}.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: extension-packages
        path: |
          immersive-memorize-${{ steps.get_version.outputs.version }}.zip
          immersive-memorize-${{ steps.get_version.outputs.version }}.tar.gz
        retention-days: 30